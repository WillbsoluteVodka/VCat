# VCat 对话功能规格说明书 (Spec)

> 负责人：Song  
> 创建日期：2026-01-05  
> 状态：待开发

---

## 📋 功能概述

将现有的 Coding 模式从「打开 TextEdit/Terminal」改为「Siri 风格的对话框」，实现用户与猫咪的直接对话交互。

### 核心目标
- 完全替代现有的 `showtxt()` 和 `runterminal()` 实现
- 提供类似 macOS Siri 的对话体验
- 支持 rule-based 指令（后期可扩展接入 AI）

---

## 🎯 触发方式

| 触发类型 | 方式 | 优先级 |
|---------|------|--------|
| 自动触发 | 状态机：SITTING → 1% 概率 → CODING | 保留现有逻辑 |
| 主动触发 | 语音唤醒（NSSpeechRecognizer） | Phase 3 实现 |

> **免打扰模式**：由 tu 负责的 Control Panel / Setting 窗口实现，不在本 spec 范围内。

---

## 🎨 UI/UX 设计

### 对话框位置
- **跟随猫咪位置**：对话框从猫咪头顶冒出，像气泡一样
- 猫咪移动时，对话框跟随移动

### 猫咪状态
- 对话框打开时：**保持在原位播放 coding 动画**
- 对话框关闭后：**立即恢复正常状态机**（walking/sitting 等）

### 视觉风格

| 阶段 | 实现方式 |
|------|---------|
| Phase 1-2 | 纯 PyQt5 (`QGraphicsBlurEffect` 模拟毛玻璃) |
| Phase 4 | macOS 原生 API (`NSVisualEffectView` via PyObjC) |

**设计要素**：
- 深色半透明背景
- 圆角边框
- 输入框 + 发送按钮
- 可滚动的聊天历史区域
- 关闭按钮 (X)

### 输入方式

| 阶段 | 支持方式 |
|------|---------|
| Phase 1-2 | 仅文字输入 |
| Phase 3 | 语音唤醒 + 语音输入 + 文字输入 |

### 对话历史
- **可滚动查看历史**（类似聊天软件）
- 会话内持久化，关闭对话框后清空

---

## 💬 指令系统

### 指令格式
- **两者都支持**：自然语言优先匹配，失败后尝试命令解析
- 示例：
  - 自然语言："你好呀小猫"、"今天天气怎么样"
  - 命令式：`/help`、`/sleep`

### Phase 1 核心指令（Hardcode）

| 用户输入示例 | 猫咪回复 |
|-------------|---------|
| hello / hi / 你好 | "主人好喵～有什么可以帮你的喵？" |
| 你是谁 / who are you | "我是你的小猫咪喵～陪你一起玩耍喵～" |
| 你在干嘛 | "我在想主人喵～" |
| 晚安 / good night | "主人晚安喵～做个好梦喵～" |
| 无法识别的输入 | "听不懂呢喵？试试输入 /help 看看我能做什么喵～" |
| /help | 显示可用指令列表 |

### 回复风格规范
- **可爱猫咪风格**
- **每句话结尾必须带「喵～」**
- 示例："主人要上网冲浪吗喵～？马上帮你开喵～"

### Future 指令扩展（接入 AI 后）

| 功能类型 | 示例 |
|---------|------|
| 打招呼/闲聊 | 自由对话 |
| 查询天气 | "今天天气怎么样" |
| 打开应用 | "帮我打开浏览器" |
| 控制猫咪行为 | "去睡觉吧"、"走动一下" |
| Agent 功能 | 控制 Desktop/Chrome/Sandbox |

---

## 🔄 交互流程与状态管理

### 对话框生命周期
触发对话（自动/语音唤醒）
│
▼
检查是否已有对话框打开 ───是──► 忽略重复触发
│否
▼
猫咪切换到 CODING 状态（播放 coding 动画）
│
▼
显示对话框（跟随猫咪位置）
│
▼
用户输入 ──► 指令解析 ──► 猫咪回复
│
▼
用户点击关闭按钮 (X)
│
▼
关闭对话框
│
▼
猫咪恢复正常状态机（SITTING → 下一状态）


### 关闭方式
- **仅支持点击关闭按钮 (X)**

### 对话中断场景

| 场景 | 处理方式 |
|------|---------|
| 对话中触发传送门 | **阻止操作**，弹窗提示"请先结束对话喵～" |
| 对话中触发 Go Up (菜单栏) | **阻止操作**，弹窗提示"请先结束对话喵～" |
| 重复触发对话 | **忽略**，不做任何处理 |

### 多猫场景（Future）
- **每只猫有独立对话框**
- 需要设计对话框 z-index 管理

---

## 🛠 技术实现

### 语音识别技术选型

| 阶段 | 方案 | 说明 |
|------|------|------|
| Phase 3 | NSSpeechRecognizer (macOS 系统级) | 免费、离线、低延迟，仅支持英文 |
| Future | Whisper / 云端 API | 多语言、高准确率 |

### 对话框实现

| 组件 | 技术方案 |
|------|---------|
| 对话框窗口 | `QDialog` / `QWidget` (无边框、透明背景) |
| 毛玻璃效果 (Phase 1-3) | `QGraphicsBlurEffect` |
| 毛玻璃效果 (Phase 4) | `NSVisualEffectView` via PyObjC |
| 聊天历史 | `QScrollArea` + `QVBoxLayout` |
| 输入框 | `QLineEdit` |
| 位置跟随 | 监听猫咪位置变化，更新对话框坐标 |

### 需要修改的文件

| 文件 | 修改内容 |
|------|---------|
| `src/behavior/actions/pet_code.py` | 替换 `showtxt()` 和 `runterminal()` 调用 |
| `src/ui/` | 新增 `chat_dialog.py` |
| `src/` | 新增 `chat_handler.py` (指令解析) |
| `src/main_window.py` | 添加对话框状态管理、阻止其他操作的逻辑 |

### 新增文件结构
src/
├── ui/
│ └── chat_dialog.py # 对话框 UI 组件
├── chat/
│ ├── init.py
│ ├── handler.py # 指令解析与回复生成
│ └── commands.py # Hardcode 指令定义


---

## 📅 开发计划

| 阶段 | 内容 | 预估工作量 | 依赖 |
|------|------|-----------|------|
| **Phase 1** | 基础对话框 UI + 文字输入 + hardcode 回复 | 2-3 天 | 无 |
| **Phase 2** | 气泡跟随猫咪位置 | 1-2 天 | Phase 1 |
| **Phase 3** | 语音唤醒 + 语音输入 (NSSpeechRecognizer) | 2-3 天 | Phase 2 |
| **Phase 4** | 毛玻璃效果优化 (NSVisualEffectView) | 1-2 天 | Phase 1 |
| **Phase 5** | 接入 AI（GPT/Claude API） | 1-2 天 | Phase 1 |

### Phase 1 详细任务

- [ ] 创建 `ChatDialog` 类 (QWidget)
- [ ] 实现聊天历史滚动区域
- [ ] 实现输入框 + 发送按钮
- [ ] 实现关闭按钮
- [ ] 创建 `ChatHandler` 类
- [ ] 实现 hardcode 指令匹配
- [ ] 实现猫咪风格回复生成
- [ ] 修改 `pet_code.py` 调用新对话框
- [ ] 实现对话框打开时阻止其他操作
- [ ] 实现对话框关闭后恢复状态机

---

## ⚠️ 注意事项

1. **对话框必须置顶**：使用 `Qt.WindowStaysOnTopHint`
2. **点击穿透问题**：对话框区域需要能接收鼠标事件，不能设置 `WindowTransparentForInput`
3. **多屏幕支持**：对话框位置计算需要考虑猫咪所在的屏幕
4. **状态锁定**：对话框打开时，`BehaviorManager` 需要暂停状态转换

---

## 🔗 与其他功能的关联

| 功能 | 负责人 | 关联说明 |
|------|--------|---------|
| Control Panel / Setting | tu | 免打扰模式、对话触发概率配置 |
| 传送门房间 | zhao | 多猫对话框管理 |
| 拖拽小猫 | ld | 拖拽时需要关闭对话框 |